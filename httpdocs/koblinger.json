{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "description": "Pjuskeby Single Source of Truth: Moduler ⇄ Data ⇄ API ⇄ UI ⇄ Cron ⇄ Cache. Alle relasjoner, avhengigheter og guardrails defineres her.",
  "version": "1.0.0",
  "updated": "2025-10-16T12:00:00Z",
  "modules": {
    "data.foundation": {
      "description": "Baseline data normalisering og validering",
      "reads": [
        "httpdocs/json/people.json",
        "httpdocs/json/placespjuskeby.json",
        "httpdocs/json/streets.json",
        "httpdocs/json/businesses.json",
        "httpdocs/json/aroundtown.json",
        "httpdocs/json/lakes.json",
        "httpdocs/json/oneliners.json",
        "httpdocs/json/endings.json",
        "httpdocs/json/endings_full.json"
      ],
      "writes": [
        "content/data/people.normalized.json",
        "content/data/places.normalized.json",
        "content/data/streets.normalized.json",
        "content/data/businesses.normalized.json",
        "content/data/organizations.normalized.json",
        "content/data/events.normalized.json",
        "content/data/lakes.normalized.json",
        "content/indexed/search.ndjson"
      ],
      "schemas": [
        "packages/schemas/person.schema.json",
        "packages/schemas/place.schema.json",
        "packages/schemas/event.schema.json",
        "packages/schemas/street.schema.json",
        "packages/schemas/business.schema.json",
        "packages/schemas/organization.schema.json",
        "packages/schemas/lake.schema.json",
        "packages/schemas/calendar.schema.json"
      ],
      "relations": [
        {
          "from": "person.street_id",
          "to": "street.id",
          "type": "1:1",
          "required": true,
          "description": "Hver person må bo i en gyldig gate"
        },
        {
          "from": "person.workplace_id",
          "to": "organization.id|business.id",
          "type": "0:1",
          "required": false,
          "description": "Person kan jobbe i organisasjon eller bedrift"
        },
        {
          "from": "event.place_id",
          "to": "place.id",
          "type": "1:1",
          "required": true,
          "description": "Hendelse må skje på et gyldig sted"
        },
        {
          "from": "business.street_id",
          "to": "street.id",
          "type": "1:1",
          "required": true,
          "description": "Bedrift må ligge i en gyldig gate"
        },
        {
          "from": "place.category",
          "to": "enum:place_categories",
          "type": "1:1",
          "required": true,
          "description": "Sted må ha gyldig kategori"
        }
      ],
      "db": [],
      "api": [],
      "cron": [],
      "cache_keys": [
        "geo:*",
        "people:index",
        "places:index",
        "streets:index",
        "businesses:index"
      ],
      "guardrails": [
        "Alle IDs må være UUIDv4",
        "Alle slugs må være URL-safe",
        "created_at og updated_at må være ISO 8601",
        "Ingen null-verdier i required-felter",
        "Alle relasjoner må valideres før skriving"
      ]
    },
    "comments": {
      "description": "Brukerkommentarer med moderasjon og spam-beskyttelse",
      "reads": [
        "content/data/*.normalized.json"
      ],
      "writes": [
        "db.comments",
        "db.moderation_log"
      ],
      "schemas": [
        "packages/schemas/comment.schema.json"
      ],
      "relations": [
        {
          "from": "comment.post_slug",
          "to": "content.slug",
          "type": "N:1",
          "required": true,
          "description": "Kommentar må tilhøre et gyldig innlegg"
        },
        {
          "from": "comment.parent_id",
          "to": "comment.id",
          "type": "0:1",
          "required": false,
          "description": "Kommentar kan være svar på annen kommentar"
        }
      ],
      "db": [
        "comments",
        "moderation_log",
        "rate_limits"
      ],
      "api": [
        "POST /api/comments",
        "GET /api/comments?post_slug={slug}",
        "PATCH /api/comments/{id}/moderate"
      ],
      "cron": [],
      "cache_keys": [
        "comments:{post_slug}",
        "comments:pending:count"
      ],
      "security": [
        "cloudflare-turnstile",
        "rate-limit: 3/hour per IP",
        "ip-hash + user-agent fingerprint",
        "akismet integration (optional)",
        "status=pending default",
        "admin-only moderation"
      ],
      "guardrails": [
        "Ingen kommentarer publiseres uten moderasjon",
        "Rate limiting må være aktivt",
        "Turnstile-validering server-side",
        "Ingen PII i logs"
      ]
    },
    "ai.daily": {
      "description": "AI-generering av daglige historier (Livet hos Agatha, Rykter)",
      "reads": [
        "content/data/*.normalized.json",
        "koblinger.json",
        "AI-learned/fungerer.json",
        "AI-learned/godekilder.json"
      ],
      "writes": [
        "content/drafts/daily/*.mdx",
        "logs/ai/decisions/*.json",
        "AI-learned/usikkert.json"
      ],
      "schemas": [
        "packages/schemas/daily-story.schema.json",
        "packages/schemas/ai-decision.schema.json"
      ],
      "relations": [
        {
          "from": "daily.characters",
          "to": "person.id",
          "type": "N:M",
          "required": true,
          "description": "Historie må inneholde gyldige personer"
        },
        {
          "from": "daily.location",
          "to": "place.id",
          "type": "1:1",
          "required": true,
          "description": "Historie må utspille seg på gyldig sted"
        }
      ],
      "db": [],
      "api": [],
      "cron": [
        "0 6 * * * Europe/Oslo"
      ],
      "cache_keys": [],
      "rules": [
        "auto-slotting: max 1 ny historie per 2 dager",
        "human-approval-required før publisering",
        "fallback: 'Rolig dag i Pjuskeby' ved feil",
        "logg alle beslutninger i logs/ai/decisions/",
        "aldri skriv direkte til content/published/"
      ],
      "guardrails": [
        "Alle genererte filer må ha Guardrails-kommentar",
        "Må bruke baseline data, aldri oppfinne personer/steder",
        "Beslutningslogg må inneholde: dato, input, output, confidence, sources",
        "Ved lav confidence (<0.7): marker som usikkert.json"
      ]
    },
    "map": {
      "description": "Interaktivt MapLibre-kart med lag for gater, steder, hendelser, rykter",
      "reads": [
        "content/data/geo/streets.geojson",
        "content/data/geo/places.geojson",
        "content/data/geo/events.geojson",
        "content/data/geo/rumors.geojson"
      ],
      "writes": [],
      "schemas": [
        "packages/schemas/geojson.schema.json"
      ],
      "relations": [
        {
          "from": "geojson.properties.id",
          "to": "place.id|street.id|event.id",
          "type": "1:1",
          "required": true,
          "description": "GeoJSON-feature må referere gyldig entitet"
        }
      ],
      "db": [],
      "api": [
        "GET /api/today",
        "GET /api/map/layers/{layer}"
      ],
      "cron": [],
      "cache_keys": [
        "map:layers:*",
        "map:today"
      ],
      "ui": [
        "MapLibre layers: streets, places, events, rumors",
        "Layer toggles",
        "POI popover with related stories",
        "Night/day mode",
        "Season overlay (optional)"
      ],
      "guardrails": [
        "Ingen tomme POIs",
        "Alle koordinater må være innenfor Pjuskeby bounds",
        "Cluster for >50 features",
        "Lazy-load layers"
      ]
    },
    "seo.aio": {
      "description": "SEO og AI-Overviews optimalisering",
      "reads": [
        "content/**/*.mdx",
        "content/data/*.normalized.json"
      ],
      "writes": [
        "public/sitemap.xml",
        "public/sitemap-stories.xml",
        "public/sitemap-series.xml",
        "public/sitemap-podcast.xml",
        "public/og-images/*.png"
      ],
      "schemas": [
        "packages/schemas/jsonld.schema.json"
      ],
      "relations": [],
      "db": [],
      "api": [],
      "cron": [
        "0 3 * * * Europe/Oslo"
      ],
      "cache_keys": [],
      "json-ld": [
        "WebSite + SearchAction",
        "Book / CreativeWork",
        "BlogPosting",
        "PodcastSeries + PodcastEpisode",
        "BreadcrumbList",
        "Person (for karakterer)",
        "Place (for steder)"
      ],
      "guardrails": [
        "Alle OG-bilder må genereres",
        "JSON-LD må valideres mot schema.org",
        "Sitemaps må være < 50k URLs hver"
      ]
    },
    "kofi": {
      "description": "Ko-fi integrasjon for støtte",
      "reads": [],
      "writes": [
        "db.donations",
        "content/data/supporters.json"
      ],
      "schemas": [
        "packages/schemas/donation.schema.json"
      ],
      "relations": [],
      "db": [
        "donations"
      ],
      "api": [
        "POST /api/webhooks/kofi"
      ],
      "cron": [],
      "cache_keys": [
        "supporters:leaderboard",
        "supporters:milestones"
      ],
      "security": [
        "webhook signature verification",
        "IP whitelist (Ko-fi servers)"
      ],
      "guardrails": [
        "Webhook må validere signatur",
        "Alle donasjoner logges i DB",
        "Personvern: kun vise navn hvis tillatelse gitt"
      ]
    },
    "podcast": {
      "description": "Podcast feed og episodesider",
      "reads": [
        "content/podcast/*.mdx",
        "content/data/places.normalized.json"
      ],
      "writes": [
        "public/feed/podcast.xml"
      ],
      "schemas": [
        "packages/schemas/podcast-episode.schema.json"
      ],
      "relations": [
        {
          "from": "episode.locations",
          "to": "place.id",
          "type": "N:M",
          "required": false,
          "description": "Episode kan referere til steder"
        }
      ],
      "db": [],
      "api": [],
      "cron": [],
      "cache_keys": [
        "podcast:feed"
      ],
      "guardrails": [
        "Feed må validere mot podcast standards",
        "iTunes tags må være komplette",
        "MP3 og cover må være hosted"
      ]
    },
    "auth.admin": {
      "description": "Admin-autentisering for moderasjon og AI-godkjenning",
      "reads": [],
      "writes": [
        "db.users",
        "db.sessions"
      ],
      "schemas": [
        "packages/schemas/user.schema.json"
      ],
      "relations": [],
      "db": [
        "users",
        "sessions"
      ],
      "api": [
        "POST /api/auth/login",
        "POST /api/auth/logout",
        "GET /api/auth/me"
      ],
      "cron": [
        "0 4 * * * Europe/Oslo (session cleanup)"
      ],
      "cache_keys": [],
      "security": [
        "bcrypt password hashing",
        "session tokens (32 bytes random)",
        "rate limiting on login",
        "2FA optional (TOTP)"
      ],
      "guardrails": [
        "Passordhash må bruke bcrypt cost >= 12",
        "Sessions må expire etter 7 dager",
        "Superbruker (Terje Dahl) seedes i migrasjon"
      ]
    },
    "wipe": {
      "description": "Slett alle dynamiske data (ikke baseline)",
      "reads": [
        "koblinger.json"
      ],
      "writes": [
        "db.* (truncate dynamiske tabeller)",
        "content/drafts/* (slett genererte utkast)",
        "logs/wipe-*.json"
      ],
      "schemas": [],
      "relations": [],
      "db": [
        "comments",
        "moderation_log",
        "rate_limits",
        "donations",
        "sessions",
        "webpush_endpoints"
      ],
      "api": [
        "POST /api/admin/wipe-all"
      ],
      "cron": [],
      "cache_keys": [
        "*:* (flush all)"
      ],
      "security": [
        "admin-only",
        "double confirmation required",
        "dry-run mode"
      ],
      "guardrails": [
        "ALDRI slett httpdocs/json/* (baseline)",
        "ALDRI slett content/published/* uten eksplisitt flag",
        "ALDRI slett AI-learned/*",
        "Logg alt i logs/wipe-{timestamp}.json",
        "Krever to separate bekreftelser"
      ]
    }
  },
  "enums": {
    "place_categories": [
      "residential",
      "commercial",
      "public",
      "nature",
      "historic",
      "fictional"
    ],
    "comment_status": [
      "pending",
      "approved",
      "rejected",
      "spam"
    ],
    "user_role": [
      "superadmin",
      "moderator",
      "author"
    ]
  },
  "global_guardrails": [
    "Ingen placeholders: TODO, FIXME, coming soon, lorem, mock, dummy, tbd, her kommer",
    "Alle hemmeligheter i .env, aldri hardkodet",
    "Alle mutasjoner logges i donetoday.json",
    "AI genererer kun drafts, aldri direkte publisering",
    "Pre-commit hooks blokkerer forbudte strenger",
    "CI validerer schemas, koblinger, relasjoner",
    "Alle nye filer starter med Guardrails-kommentar",
    "API kjører på port 4100 (verifisert ledig, ikke forstyrr andre vhosts)"
  ]
}
