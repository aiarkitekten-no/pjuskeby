---
interface Props {
  rumor: any;
  category: any;
  archetype: any;
}

const { rumor, category, archetype } = Astro.props;

// Format date
const date = new Date(rumor.date);
const formattedDate = date.toLocaleDateString('nb-NO', { 
  day: 'numeric', 
  month: 'long', 
  year: 'numeric',
  hour: '2-digit',
  minute: '2-digit'
});

// Calculate credibility color
function getCredibilityColor(credibility: number) {
  if (credibility >= 70) return '#10b981'; // green
  if (credibility >= 50) return '#f59e0b'; // orange
  return '#ef4444'; // red
}

const credibilityColor = getCredibilityColor(rumor.credibility);
---

<article 
  class="rumour-card"
  data-category={rumor.category}
  data-date={rumor.date}
  data-credibility={rumor.credibility}
  data-title={rumor.title}
  data-content={rumor.content}
  data-views={rumor.interactions?.views || 0}
  data-confirmed={rumor.interactions?.confirmed || 0}
  data-debunked={rumor.interactions?.debunked || 0}
  data-shared={rumor.interactions?.shared || 0}
>
  <a href={`/rykter/${rumor.id}`} class="rumour-card-link">
  <!-- Category Badge -->
  <div class="category-badge" style={`background-color: ${category.color}15; color: ${category.color};`}>
    <span class="category-icon">{category.icon}</span>
    <span class="category-name">{category.name}</span>
  </div>

  <!-- Header -->
  <header class="rumour-header">
    <h2 class="rumour-title">{rumor.title}</h2>
    <div class="rumour-meta">
      <time datetime={rumor.date} class="rumour-date">
        {formattedDate}
      </time>
    </div>
  </header>

  <!-- Content -->
  <div class="rumour-content">
    <p>{rumor.content}</p>
  </div>

  <!-- Mentions -->
  {(rumor.characters?.length > 0 || rumor.locations?.length > 0) && (
    <div class="rumour-mentions">
      {rumor.characters && rumor.characters.length > 0 && (
        <div class="mention-group">
          <strong>üë§ Personer:</strong>
          {rumor.mentions
            .filter((m: any) => m.type === 'person')
            .map((m: any, index: number) => (
              <>
                <a href={`/personer/${m.slug}`} class="mention-link">
                  {m.name}
                </a>
                {index < rumor.mentions.filter((x: any) => x.type === 'person').length - 1 ? ', ' : ''}
              </>
            ))
          }
        </div>
      )}
      {rumor.locations && rumor.locations.length > 0 && (
        <div class="mention-group">
          <strong>üìç Steder:</strong>
          {rumor.mentions
            .filter((m: any) => m.type === 'place')
            .map((m: any, index: number) => (
              <>
                <a href={`/steder/${m.slug}`} class="mention-link">
                  {m.name}
                </a>
                {index < rumor.mentions.filter((x: any) => x.type === 'place').length - 1 ? ', ' : ''}
              </>
            ))
          }
        </div>
      )}
      {rumor.mentions && rumor.mentions.filter((m: any) => m.type === "street").length > 0 && (
        <div class="mention-group">
          <strong>üõ£Ô∏è  Gater:</strong>
          {rumor.mentions
            .filter((m: any) => m.type === "street")
            .map((m: any, index: number) => (
              <>
                <a href={`/gater/${m.slug}`} class="mention-link">
                  {m.name}
                </a>
                {index < rumor.mentions.filter((x: any) => x.type === "street").length - 1 ? ", " : ""}
              </>
            ))
          }
        </div>
      )}
      {rumor.mentions && rumor.mentions.filter((m: any) => m.type === "business").length > 0 && (
        <div class="mention-group">
          <strong>üè¢ Bedrifter:</strong>
          {rumor.mentions
            .filter((m: any) => m.type === "business")
            .map((m: any, index: number) => (
              <>
                <a href={`/bedrifter/${m.slug}`} class="mention-link">
                  {m.name}
                </a>
                {index < rumor.mentions.filter((x: any) => x.type === "business").length - 1 ? ", " : ""}
              </>
            ))
          }
        </div>
      )}
    </div>
  )}

  <!-- Footer -->
  <footer class="rumour-footer">
    <div class="source-info">
      <span class="source-label">Kilde:</span>
      <span class="source-name">{rumor.sourceName}</span>
      <span class="source-type">({archetype.name})</span>
    </div>
    <div class="credibility-meter">
      <span class="credibility-label">Troverdighet:</span>
      <div class="credibility-bar">
        <div 
          class="credibility-fill" 
          style={`width: ${rumor.credibility}%; background-color: ${credibilityColor};`}
        ></div>
      </div>
      <span class="credibility-value" style={`color: ${credibilityColor};`}>
        {rumor.credibility}%
      </span>
    </div>
  </footer>
  </a>
</article>

<style>
  .rumour-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
  }

  .rumour-card-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .rumour-card:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    transform: translateY(-2px);
    cursor: pointer;
  }

  .category-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .category-icon {
    font-size: 1rem;
  }

  .rumour-header {
    margin-bottom: 1rem;
  }

  .rumour-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 0.5rem 0;
    line-height: 1.3;
  }

  .rumour-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    color: #64748b;
  }

  .rumour-date {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .rumour-date::before {
    content: 'üïí';
  }

  .rumour-content {
    font-size: 1rem;
    line-height: 1.6;
    color: #334155;
    margin-bottom: 1.25rem;
  }

  .rumour-content p {
    margin: 0;
  }

  .rumour-mentions {
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
    margin-bottom: 1.25rem;
    font-size: 0.875rem;
  }

  .mention-group {
    margin-bottom: 0.5rem;
  }

  .mention-group:last-child {
    margin-bottom: 0;
  }

  .mention-link {
    color: #3b82f6;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .mention-link:hover {
    color: #2563eb;
    text-decoration: underline;
  }

  .rumour-footer {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
  }

  .source-info {
    font-size: 0.875rem;
    color: #64748b;
  }

  .source-label {
    font-weight: 600;
  }

  .source-name {
    font-style: italic;
    margin-left: 0.25rem;
  }

  .source-type {
    color: #94a3b8;
    font-size: 0.8rem;
  }

  .credibility-meter {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
  }

  .credibility-label {
    font-weight: 600;
    color: #475569;
    white-space: nowrap;
  }

  .credibility-bar {
    flex: 1;
    height: 8px;
    background: #e2e8f0;
    border-radius: 999px;
    overflow: hidden;
  }

  .credibility-fill {
    height: 100%;
    transition: width 0.3s ease;
  }

  .credibility-value {
    font-weight: 700;
    min-width: 45px;
    text-align: right;
  }

  @media (max-width: 768px) {
    .rumour-card {
      padding: 1.25rem;
    }

    .rumour-title {
      font-size: 1.25rem;
    }

    .rumour-footer {
      gap: 0.75rem;
    }
  }
</style>
